<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Behind the Scenes with nil? and empty? &#8211; Daniel Nill</title>
<meta name="description" content="">
<meta name="keywords" content="">
<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/">
<meta name="twitter:title" content="Behind the Scenes with nil? and empty?">
<meta name="twitter:description" content="">
<meta name="twitter:creator" content="@DanielNill">
<link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Daniel Nill" />

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Behind the Scenes with nil? and empty?">
<meta property="og:description" content="">
<meta property="og:url" content="/behind-the-scenes-with-nil-and-empty">
<meta property="og:site_name" content="Daniel Nill">





<link rel="canonical" href="/behind-the-scenes-with-nil-and-empty">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Daniel Nill Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700|PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.min.css">

<!--[if (lt IE 9) & (!IEMobile)]>
<link rel="stylesheet" href="/assets/css/ie.min.css">
<![endif]-->

<meta http-equiv="cleartype" content="on">

</head>

<body class="page" itemscope itemtype="http://schema.org/WebPage">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="">Daniel Nill</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
		    <ul>
		        
				<li><a href="/" >Posts</a></li>
		        
				<li><a href="/about.html" >About</a></li>
		        
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->




<div id="main" role="main"  itemprop="mainContentOfPage">
  <div class="article-author-side">
    <!-- <img src="/images/profile-photo-new1.jpg" class="bio-photo" alt="Daniel Nill bio photo"></a> -->
<p></p>
<br/>
<a href="http://twitter.com/DanielNill" class="author-social" target="_blank"><i class="icon-twitter"></i> Twitter</a>


<a href="http://linkedin.com/in/danielnill" class="author-social" target="_blank"><i class="icon-linkedin"></i> LinkedIn</a>

<a href="http://github.com/DanielNill" class="author-social" target="_blank"><i class="icon-github"></i> Github</a>



  </div>
  <article itemscope itemtype="http://schema.org/CreativeWork">
    <h1 itemprop="name">Behind the Scenes with nil? and empty?</h1>
    <div class="article-wrap" itemprop="text">
      <p>At their base level the ruby methods nil? and empty? are just contents checks with slightly different focuses.  But I thought it would be interesting and maybe even useful to look at how each actually opperates.</p>

<h4 id="why-are-you-writing-this">Why are you writing this</h4>

<p>Mostly just for shits and giggles, and because I was currious about the core implementations of these methods.</p>

<h4 id="nil">nil?</h4>

<p>First, let’s take a look at <code class="language-plaintext highlighter-rouge">nil?</code>.  It is the most simplistic of the three methods and is easy to understand at a source code level.  First we should know what the method does.  Calling <code class="language-plaintext highlighter-rouge">nil?</code> simply checks the object is is called on and returns whether it is of the nil object type or not.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="kp">nil</span><span class="p">.</span><span class="nf">nil?</span> <span class="c1"># =&gt; true</span>
  <span class="s2">""</span><span class="p">.</span><span class="nf">nil?</span> <span class="c1"># =&gt; false</span>
  <span class="mi">0</span><span class="p">.</span><span class="nf">nil?</span> <span class="c1"># =&gt; false</span>
  <span class="p">[].</span><span class="nf">nil?</span> <span class="c1"># =&gt; false</span>
  <span class="p">{}.</span><span class="nf">nil?</span> <span class="c1"># =&gt; false</span>
  <span class="no">NilClass</span><span class="p">.</span><span class="nf">nil?</span> <span class="c1"># =&gt; false</span></code></pre></figure>

<p>If you accept that <code class="language-plaintext highlighter-rouge">nil?</code> will only return true if it’s owner is nil, this everything in this result set should make sense.  The only thing that might give you pause is <code class="language-plaintext highlighter-rouge">NilClass.nil? # =&gt; false</code>, but this should be quickly cleared up by seeing that NilClass is the class of the singleton object nil in ruby.  This simply means that NilClass can only instantiate to the instance nil, and is only instantiated through the keyword <code class="language-plaintext highlighter-rouge">nil</code>.</p>

<p>To implement this functionality, ruby does four things in its source:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">  <span class="c1">// 1) define a function to return the ruby object false</span>
  <span class="k">static</span> <span class="n">VALUE</span>
  <span class="nf">rb_false</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">obj</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">Qfalse</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// 2) define a function to return the ruby object true</span>
  <span class="k">static</span> <span class="n">VALUE</span>
  <span class="nf">rb_true</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">obj</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">Qtrue</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// 3) define the Object class and assign functionality to the nil? method</span>
  <span class="n">rb_mKernel</span> <span class="o">=</span> <span class="n">rb_define_module</span><span class="p">(</span><span class="s">"Kernel"</span><span class="p">);</span>
  <span class="n">rb_define_method</span><span class="p">(</span><span class="n">rb_mKernel</span><span class="p">,</span> <span class="s">"nil?"</span><span class="p">,</span> <span class="n">rb_false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="c1">// 4) define the NilClass and assign functionality to the nil? method</span>
  <span class="n">rb_cNilClass</span> <span class="o">=</span> <span class="n">rb_define_class</span><span class="p">(</span><span class="s">"NilClass"</span><span class="p">,</span> <span class="n">rb_cObject</span><span class="p">);</span>
  <span class="n">rb_define_method</span><span class="p">(</span><span class="n">rb_cNilClass</span><span class="p">,</span> <span class="s">"nil?"</span><span class="p">,</span> <span class="n">rb_true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p>Most of this is pretty straight forward but there are a few things to make note of.  <code class="language-plaintext highlighter-rouge">VALUE</code> is a pointer to an object, so it’s use in this code is simply stating that both methods take in an object and return an object.  More specifically for the <code class="language-plaintext highlighter-rouge">rb_true</code> and <code class="language-plaintext highlighter-rouge">rb_false</code> methods they take take in an instance of the base ruby Object class and return an either an instance of TrueClass or FalseClass.</p>

<p><code class="language-plaintext highlighter-rouge">Qfalse</code> and <code class="language-plaintext highlighter-rouge">Qtrue</code> are instances of  <code class="language-plaintext highlighter-rouge">VALUE</code> and represent the singleton objects of the ruby classes TrueClass and FalseClass.  This is significant only in that it is useful to note that ruby’s true and false are not the same thing as c’s true and false, although they can be converted.</p>

<p>Next, you’ll probably note the strange method <code class="language-plaintext highlighter-rouge">rb_define_module</code>.  This function creates a module that is used in this case by the Object class which is defined by <code class="language-plaintext highlighter-rouge">rb_cObject = rb_define_class("Object", rb_cBasicObject);</code>.  Methods that are core to the Object class and don’t extend to other classes are defined directly on the object class where as methods that do extend are defined on the kernal module.</p>

<p>Lastly <code class="language-plaintext highlighter-rouge">rb_define_method</code> takes an class definition, a stringified name for the method being defined, a function pointer to deliver it’s returned value and the number of arguments expected to be passed to the method.</p>

<h4 id="empty">empty?</h4>

<p><code class="language-plaintext highlighter-rouge">empty?</code> is a core ruby method, but it is only implemented on certain ruby object types. It is not implemented on the ruby ObjectClass and then extended to all other clases.  Instead it is implemented only on classes that can have a lenght or count.  First a few examples.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">[].</span><span class="nf">empty?</span> <span class="c1"># =&gt; true</span>
<span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">empty?</span> <span class="c1"># =&gt; false</span>
<span class="p">{}.</span><span class="nf">empty?</span> <span class="c1"># =&gt; true</span>
<span class="p">{</span> <span class="ss">a: </span><span class="mi">1</span> <span class="p">}.</span><span class="nf">empty?</span> <span class="c1"># =&gt; false</span>
<span class="s2">""</span><span class="p">.</span><span class="nf">empty?</span> <span class="c1"># =&gt; true</span>
<span class="s2">"hello"</span><span class="p">.</span><span class="nf">empty?</span> <span class="c1"># =&gt; false</span>
<span class="ss">:hello</span><span class="p">.</span><span class="nf">empty?</span> <span class="c1"># =&gt; false</span>
<span class="ss">:""</span><span class="p">.</span><span class="nf">empty?</span> <span class="c1"># =&gt; true</span></code></pre></figure>

<p>Again, going through how these results are generated will give a deeper understanding of what is actually happening when we make even these basic method calls.</p>

<p>First, let’s look at the source codes for the <code class="language-plaintext highlighter-rouge">empty?</code> methods.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// String#empty?</span>
<span class="k">static</span> <span class="n">VALUE</span>
<span class="nf">rb_str_empty</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">RSTRING_LEN</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Qtrue</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">Qfalse</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//...</span>
<span class="n">rb_define_method</span><span class="p">(</span><span class="n">rb_cString</span><span class="p">,</span> <span class="s">"empty?"</span><span class="p">,</span> <span class="n">rb_str_empty</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p>This looks relatively familiar to what we saw before with the <code class="language-plaintext highlighter-rouge">nil?</code> definition.  There’s a little more logic but it’s really not too hard to work through.</p>

<p>First we see that the function takes in a <code class="language-plaintext highlighter-rouge">VALUE</code> pointer object and returns a <code class="language-plaintext highlighter-rouge">VALUE</code> pointer object.  In this case it takes in a pointer to an object that is expected to be a string and returns a the <code class="language-plaintext highlighter-rouge">Qtrue</code> or <code class="language-plaintext highlighter-rouge">Qfalse</code> <code class="language-plaintext highlighter-rouge">VALUE</code> instances.  When we look at the logic inside the function we can see that is does exactly what we’d expect it to do.  It checks the string’s length using <code class="language-plaintext highlighter-rouge">RSTRING_LEN</code>, a custom string length method implemented for ruby, and return <code class="language-plaintext highlighter-rouge">Qtrue</code> if that length is 0.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Array#empty?</span>
<span class="k">static</span> <span class="n">VALUE</span>
<span class="nf">rb_ary_empty_p</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">ary</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">RARRAY_LEN</span><span class="p">(</span><span class="n">ary</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Qtrue</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">Qfalse</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//...</span>
<span class="n">rb_define_method</span><span class="p">(</span><span class="n">rb_cArray</span><span class="p">,</span> <span class="s">"empty?"</span><span class="p">,</span> <span class="n">rb_ary_empty_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p>Next, looking at the array empty method we see very similar code.  Again, the function takes in and returns <code class="language-plaintext highlighter-rouge">VALUE</code> and again it uses a custom string length function, this time <code class="language-plaintext highlighter-rouge">RARRAY_LEN</code> to check the length of the object. Again, <code class="language-plaintext highlighter-rouge">RARRAY_LEN</code> is simply a wrapper for getting the memory allocated for the array in question.  It is worth noting that an empty array in ruby does not coorespond to an empty array in C.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Hash#empty?</span>
<span class="k">static</span> <span class="n">VALUE</span>
<span class="nf">rb_hash_empty_p</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">hash</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">RHASH_EMPTY_P</span><span class="p">(</span><span class="n">hash</span><span class="p">)</span> <span class="o">?</span> <span class="n">Qtrue</span> <span class="o">:</span> <span class="n">Qfalse</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//...</span>
<span class="n">rb_define_method</span><span class="p">(</span><span class="n">rb_cHash</span><span class="p">,</span><span class="s">"empty?"</span><span class="p">,</span> <span class="n">rb_hash_empty_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p>Again, in the hash version of the function everything looks very similar.  However, there is a small diference.  This time we aren’t checking that the hash has no length, instead we are actually checking that it is empty.  This is simply because it is more expensive to get the length of a hash than it is to get the length of an array.  With an array you can simply check how much memory is allocated, where as with a hash you have to actually count the number of entities.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">Looking</span> <span class="n">at</span>
<span class="c1">// Symbol#empty?</span>
<span class="k">static</span> <span class="n">VALUE</span>
<span class="nf">sym_empty</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">sym</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">rb_str_empty</span><span class="p">(</span><span class="n">rb_id2str</span><span class="p">(</span><span class="n">SYM2ID</span><span class="p">(</span><span class="n">sym</span><span class="p">)));</span>
<span class="p">}</span>
<span class="c1">//...</span>
<span class="n">rb_define_method</span><span class="p">(</span><span class="n">rb_cSymbol</span><span class="p">,</span> <span class="s">"empty?"</span><span class="p">,</span> <span class="n">sym_empty</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p>Finally, looking at the function for <code class="language-plaintext highlighter-rouge">Symbol#empty?</code> we start to see why it works the way it does.  The short answer is that it simply casts the symbol to a string before checking whether it is empty.  But this has a few implecations to it.  First casting a symbol to a string atomatically increases the memory allocation for the variable.  It’s also worth noting that casting a symbol actually requires a chain of function calls.  First the symbol’s value must be retrieved from the global symbol table.  This is what <code class="language-plaintext highlighter-rouge">SYM2ID</code> is doing.  Next that value is cast to a string, and finally the strings memory allocations is counted.</p>

<p>In the grand scheme of things none of this is particularly costly, but it is enlightening to see what is actually going on behind the scenes.</p>


    </div><!-- /.article-wrap -->
  </article>
</div><!-- /#index -->

<div class="footer-wrap">
  <footer>
    <span>&copy; 2023 Daniel Nill.</span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-29127035-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

          

</body>
</html>
